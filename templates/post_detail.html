{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ post.title }} · 별별포럼</title>
  <style>
    :root{
      --brand:#6b5cff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --card:#fff; --chip:#f8fafc; --bg:#f6f7fb; --shadow:0 10px 30px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px}

    /* === 헤더/탭 (home과 동일) === */
    .header{display:flex;align-items:center;justify-content:space-between;margin:10px 0 18px}
    .logo{font-weight:900;letter-spacing:.2px}
    .logo a{color:var(--brand)}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;background:#fff;border:1px solid var(--line);
      border-radius:12px;padding:6px; box-shadow:var(--shadow);
    }
    .tab{
      padding:10px 14px;border-radius:10px;
      color:#1f2937; border:1px solid transparent; background:transparent; font-weight:700;
    }
    .tab:hover{background:var(--chip)}
    .tab.active{background:rgba(107,92,255,.08); color:var(--brand); border-color:rgba(107,92,255,.25)}

    /* === 본문 카드/버튼/댓글 === */
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:22px;box-shadow:var(--shadow)}
    .meta{color:var(--muted);font-size:13px}
    .title{margin:0 0 8px 0;font-size:24px;font-weight:900}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid var(--brand);background:#6b5cff;color:#fff;font-weight:800;cursor:pointer}
    .btn.secondary{background:#fff;color:#6b5cff}
    .like{display:inline-flex;align-items:center;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .comment{border-top:1px solid var(--line);padding:14px 0}
    .comment:first-child{border-top:none}
    .input, textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:12px;font-size:14px;background:#fff}
    .errorlist{color:#dc2626;margin:6px 0 0 0;padding:0;list-style:none;font-size:13px}

    @media (max-width:900px){ .container{max-width:900px} }
  </style>
</head>
<body>
  <main class="container">

    <!-- 공통 헤더/탭 -->

    <div class="header">
      <div class="logo">
        <!-- 기존: href="?tab={{ active_tab|default:'fortune' }}" -->
        <a href="{% url 'home' %}">별별포럼</a>
      </div>
      <nav class="tabs" role="tablist" aria-label="Boards">
        <!-- 기존: href="?tab=fortune" -->
        <a class="tab {% if active_tab == 'fortune' or not active_tab %}active{% endif %}"
           href="{% url 'home' %}?tab=fortune"
           role="tab" aria-selected="{% if active_tab == 'fortune' or not active_tab %}true{% else %}false{% endif %}">오늘의 운세</a>

        <a class="tab {% if active_tab == 'dream' %}active{% endif %}"
           href="{% url 'home' %}?tab=dream"
           role="tab" aria-selected="{% if active_tab == 'dream' %}true{% else %}false{% endif %}">꿈 해몽</a>

        <a class="tab {% if active_tab == 'free' %}active{% endif %}"
           href="{% url 'home' %}?tab=free"
           role="tab" aria-selected="{% if active_tab == 'free' %}true{% else %}false{% endif %}">자유게시판</a>
      </nav>
    </div>


    <!-- 글 본문 -->
    <article class="card">
      <h1 class="title">{{ post.title }}</h1>
      <div class="meta">{{ post.author_display }} · {{ post.created_at|date:"Y-m-d H:i" }}</div>
      <div class="divider"></div>
      <div class="post-body">
        {{ post.body|linebreaks }}
      </div>
      <div class="divider"></div>

      <!-- 좋아요 영역 -->
      <div class="like">
        <button id="likeBtn" class="btn" type="button">좋아요</button>
        <span class="pill">좋아요 <strong id="likeCount">{{ post.like_count }}</strong></span>
      </div>
    </article>

    <!-- 댓글: 자유게시판에서만 -->
    {% if allow_comments %}
    <section id="comments" class="card" style="margin-top:16px">
      <h2 style="margin:0 0 12px 0;font-size:18px;font-weight:900">댓글 ({{ comments_page.paginator.count }})</h2>

      {% for c in comments_page %}
        <div class="comment">
          <div style="display:flex;gap:8px;align-items:center">
            <strong>{{ c.username }}</strong>
            <span class="meta">· {{ c.created_at|date:"Y-m-d H:i" }}</span>
          </div>
          <div style="margin-top:6px;white-space:pre-line">{{ c.content }}</div>
        </div>
      {% empty %}
        <p class="meta">아직 댓글이 없습니다.</p>
      {% endfor %}

      {% if comments_page.paginator.num_pages > 1 %}
      <nav style="display:flex;gap:6px;justify-content:center;margin-top:12px">
        {% if comments_page.has_previous %}
          <a class="btn secondary" href="?cpage={{ comments_page.previous_page_number }}#comments">이전</a>
        {% endif %}
        <span class="meta" style="align-self:center">페이지 {{ comments_page.number }} / {{ comments_page.paginator.num_pages }}</span>
        {% if comments_page.has_next %}
          <a class="btn secondary" href="?cpage={{ comments_page.next_page_number }}#comments">다음</a>
        {% endif %}
      </nav>
      {% endif %}
    </section>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:0 0 12px 0;font-size:18px;font-weight:900">댓글 작성</h3>
      <form method="post" action="">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label for="{{ form.username.id_for_label }}">이름</label>
            {{ form.username }}
            {{ form.username.errors }}
          </div>
        </div>
        <div style="margin-top:10px">
          <label for="{{ form.content.id_for_label }}">내용</label>
          {{ form.content }}
          {{ form.content.errors }}
        </div>
        <button class="btn" type="submit" style="margin-top:12px">등록</button>
      </form>
    </section>
    {% endif %}
  </main>

  <script>
    // CSRF 토큰 헬퍼 (Django docs)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 좋아요 버튼
    (function(){
      const btn = document.getElementById('likeBtn');
      const counter = document.getElementById('likeCount');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          const res = await fetch(window.location.pathname + 'like/', {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
          });
          if (!res.ok) throw new Error('like failed');
          const data = await res.json();
          if (data.ok) {
            counter.textContent = data.like_count;
            btn.textContent = data.duplicate ? '이미 좋아요됨' : '좋아요 완료';
          }
        } catch (e) {
          alert('잠시 후 다시 시도해주세요.');
        }
      });
    })();
  </script>
</body>
</html>
